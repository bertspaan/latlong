<!DOCTYPE html>
<html>
<head>
	<title>Latitude/longitude of a point</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" href="style.css" />
	<script src="d3.v3.min.js"></script>
  <link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
  <script src="leaflet-hash.js"></script>
</head>
<body>
	<div id="map"></div>
  <div id="bar" class="leaflet-bar">
    <label for='latlong'>Latitude, longitude</label>
    <input type="text" id='latlong' name='latlong' />
  </div>  
	<script>
		var map = L.map('map'),
        title = "Latitude, longitude",
        template = "%lat%, %lon%";
        
    map.setView([52.3674, 4.915], 6);
    var hash = new L.Hash(map);
    
    var tileUrl = "http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png";

		var tileLayer = L.tileLayer(tileUrl, {
      attributionControl: false,
			minZoom: 2
		}).addTo(map);

    drawCrossHair();
    
    map.on('move', function() {      
  		updateLatlong();
    });
    
    function textWidth(text) {
      return text.length * 17.2 + "px";
    }
    
    function validateLatLng(latlng) {
      console.log(latlng);
      if (latlng && latlng.lat >= -90 && latlng.lat <= 90 && latlng.lng >= -180 && latlng.lng <= 180) {
        return latlng;
      } else {
        return null;
      }
    }
    
    d3.select('input').on('input', function() {
      var latlong = d3.select(this).property('value');
      d3.select(this).style('width', textWidth(latlong));
      
      var reNum = "([-+]?[0-9]*\.?[0-9]+)";

      var reTemplate = RegExp.escape(template).replace(/%.*?%/g, reNum);
     
      var value = d3.select('input').property('value');
      var match = value.match(reTemplate);
      
      // point, match must have length 3 
      if (match && match.length == 3) {
        var latlng = validateLatLng(L.latLng(match[1], match[2]));
        console.log(latlng);
      }
      
      
      
      
      // 1. kijk of latlong aan template voldoet
      // 2. kijk of latten en longen binnen resp. [-90, 90] en [-180, 180] vallen
      // 3. pan!
    });
    
    // From http://stackoverflow.com/questions/3115150/how-to-escape-regular-expression-special-characters-using-javascript
    RegExp.escape = function(text) {
      return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, "\\$&");
    };
    
    function drawCrossHair() {
      var crosshairLength = 10,
          crosshair = [
        [0, -1], [1, 0], [0, 1], [-1, 0]
      ];
      
      var g = d3.select(".leaflet-control-container")
        .append("div")
          .attr("class", "leaflet-middle")
        .append("svg")
          .attr("class", "crosshair")
          .attr("width", 64)
          .attr("height", 64)
        .append("svg:g")
          .attr("transform", "translate(32,32)")
          .selectAll('line')
          .data(crosshair);
      
      g.enter().append('line')
          .attr("class", "crosshair-outline")
          .attr("x1", function(d) { return d[0] * crosshairLength; })
          .attr("y1", function(d) { return d[1] * crosshairLength; })
          .attr("x2", function(d) { return d[0] * crosshairLength * 2; })
          .attr("y2", function(d) { return d[1] * crosshairLength * 2; });
        
      g.enter().append('line')
          .attr("x1", function(d) { return d[0] * crosshairLength; })
          .attr("y1", function(d) { return d[1] * crosshairLength; })
          .attr("x2", function(d) { return d[0] * crosshairLength * 2; })
          .attr("y2", function(d) { return d[1] * crosshairLength * 2; });
    }
    
    function templateToLatlong() {
  		var center = map.getCenter(),
  		    zoom = map.getZoom(),
	        precision = Math.max(0, Math.ceil(Math.log(zoom) / Math.LN2));
      
      return template 
          .replace('%lat%', center.lat.toFixed(precision))
          .replace('%lon%', ((center.lng + 180) % 360 - 180).toFixed(precision));
    }
           
    function updateLatlong() {
      var latlong = templateToLatlong();
      d3.select('input')
          .property('value', latlong)
          .style('width', textWidth(latlong));
    }
      
    updateLatlong();       
	</script>
</body>
</html>